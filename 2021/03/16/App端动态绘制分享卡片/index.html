<!DOCTYPE html><html data-saber-ssr><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.11.7"><meta data-saber-head="ssr" name="description" content="Everything is gonna be ok." data-hid="description"><meta data-saber-head="ssr" name="description" content="需求是在不同用户信息和分享内容的情况下，动态绘制下面的分享卡片，用户可以保存到手机中或通过分享API即时分享。
"> <title>App端动态绘制分享卡片 - Hyggehyy</title> <style data-vue-ssr-id="3b4f9aba:0 1ff93409:0 44ad3bfa:0 42912202:0 bd73a03a:0 614d9340:0 e580b356:0 eb8bfdca:0 7d35ffba:0">/*! modern-normalize | MIT License | https://github.com/sindresorhus/modern-normalize */html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}hr{height:0}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{padding:0}progress{vertical-align:baseline}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}
@charset "utf-8";html{color:#333;background:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;text-rendering:optimizelegibility}html.borderbox *,html.borderbox :after,html.borderbox :before{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}article,aside,blockquote,body,button,code,dd,details,dl,dt,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hr,input,legend,li,menu,nav,ol,p,pre,section,td,textarea,th,ul{margin:0;padding:0}article,aside,details,figcaption,figure,footer,header,menu,nav,section{display:block}audio,canvas,video{display:inline-block}body,button,input,select,textarea{font:300 1em/1.8 PingFang SC,Lantinghei SC,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}blockquote{position:relative;color:#999;font-weight:400;border-left:1px solid #1abc9c;padding-left:1em;margin:1em 3em 1em 2em}@media only screen and (max-width:640px){blockquote{margin:1em 0}}abbr,acronym{border-bottom:1px dotted;font-variant:normal}abbr{cursor:help}del{text-decoration:line-through}address,caption,cite,code,dfn,em,th,var{font-style:normal;font-weight:400}ol,ul{list-style:none}caption,th{text-align:left}q:after,q:before{content:""}sub,sup{font-size:75%;line-height:0;position:relative}:root sub,:root sup{vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}a{color:#1abc9c}a:hover{text-decoration:underline}.typo a{border-bottom:1px solid #1abc9c}.typo a:hover{border-bottom-color:#555;color:#555}.typo a:hover,a,ins{text-decoration:none}.typo-u,u{text-decoration:underline}mark{background:#fffdd1;border-bottom:1px solid #ffedce;padding:2px;margin:0 5px}code,pre,pre tt{font-family:Courier,Courier New,monospace}pre{background:#f8f8f8;border:1px solid #ddd;padding:1em 1.5em;display:block;-webkit-overflow-scrolling:touch}hr{border:none;border-bottom:1px solid #cfcfcf;margin-bottom:.8em;height:10px}.typo-small,figcaption,small{font-size:.9em;color:#888}b,strong{font-weight:700;color:#000}[draggable]{cursor:move}.clearfix:after,.clearfix:before{content:"";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.textwrap,.textwrap td,.textwrap th{word-wrap:break-word;word-break:break-all}.textwrap-table{table-layout:fixed}.serif{font-family:Palatino,Optima,Georgia,serif}.typo-dl,.typo-form,.typo-hr,.typo-ol,.typo-p,.typo-pre,.typo-table,.typo-ul,.typo dl,.typo form,.typo hr,.typo ol,.typo p,.typo pre,.typo table,.typo ul,blockquote{margin-bottom:1.2em}h1,h2,h3,h4,h5,h6{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;font-weight:100;color:#000;line-height:1.35}.typo-h1,.typo-h2,.typo-h3,.typo-h4,.typo-h5,.typo-h6,.typo h1,.typo h2,.typo h3,.typo h4,.typo h5,.typo h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}.typo-h1,.typo h1{font-size:2em}.typo-h2,.typo h2{font-size:1.8em}.typo-h3,.typo h3{font-size:1.6em}.typo-h4,.typo h4{font-size:1.4em}.typo-h5,.typo-h6,.typo h5,.typo h6{font-size:1.2em}.typo-ul,.typo ul{margin-left:1.3em;list-style:disc}.typo-ol,.typo ol{list-style:decimal;margin-left:1.9em}.typo-ol ol,.typo-ol ul,.typo-ul ol,.typo-ul ul,.typo li ol,.typo li ul{margin-bottom:.8em;margin-left:2em}.typo-ol ul,.typo-ul ul,.typo li ul{list-style:circle}.typo-table td,.typo-table th,.typo table caption,.typo table td,.typo table th{border:1px solid #ddd;padding:.5em 1em;color:#666}.typo-table th,.typo table th{background:#fbfbfb}.typo-table thead th,.typo table thead th{background:#f1f1f1}.typo table caption{border-bottom:none}.typo-input,.typo-textarea{-webkit-appearance:none;border-radius:0}.typo-em,.typo em,caption,legend{color:#000;font-weight:inherit}.typo-em{position:relative}.typo-em:after{position:absolute;top:.65em;left:0;width:100%;overflow:hidden;white-space:nowrap;content:"・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・"}.typo img{max-width:100%}
code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}
@font-face{font-family:Millunium;src:url(/_saber/fonts/Millunium.5eacc817.ttf)}body,h1,h2,h3,h4,h5,h6{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-moz-font-feature-settings:"liga" on;transition:all .25s ease}body{font-size:20px;background-color:#fff;min-height:100vh}a{color:inherit;text-decoration:none}.svg-icon{width:1em;height:1em;fill:rgba(20,20,31,.2)}.pagination{color:#888;overflow:auto;font-size:14px;border-top:1px solid #f1f1f1;padding-top:2.5em}.pagination .next-link{float:left}.pagination .prev-link{float:right}.img-suit{width:auto;height:auto;max-width:100%;max-height:100%}
article.typo .post-meta{display:block;color:#bbb;font-size:12px;font-style:italic;font-weight:lighter}article.typo{position:relative;font-size:16px}article.typo a{word-break:break-all}article.typo .pagination{display:flex;font-size:14px;justify-content:space-between}article.typo .pagination a{border-bottom:0;flex:1}article.typo .pagination a.prev{text-align:right;padding-right:10px}article.typo .pagination a.next{text-align:left;padding-left:10px}article.typo code{font-size:14px}article.typo .post-meta{margin-bottom:20px}article.typo .label{color:#888}@media screen and (min-width:600px){article.typo .post-meta{margin-bottom:30px}}
.content[data-v-7c027d9a]{display:block;position:relative;padding:25px;width:80vw;max-width:750px;margin:50px auto 0;background:#fff;box-shadow:0 10px 20px 0 hsla(0,0%,92.5%,.86)}@media screen and (min-width:600px){.content[data-v-7c027d9a]{padding:50px 0;background:transparent;box-shadow:none}}
header[data-v-2c7e4481]{width:80vw;max-width:750px;margin:0 auto}.domain[data-v-2c7e4481]{font-size:14px;font-style:italic;font-weight:300;color:#bbb;padding:80px 0;display:block}.title[data-v-2c7e4481]{font-weight:700;font-size:1.5em;font-family:Millunium}.description[data-v-2c7e4481]{font-size:16px;color:#888}.nav-links[data-v-2c7e4481]{font-size:16px;font-style:italic}.nav-links .nav-link[data-v-2c7e4481]{display:inline-block}.nav-links a[data-v-2c7e4481]{text-decoration:none;margin-right:10px;border-bottom:1px solid #bbb}.nav-links a[data-v-2c7e4481]:hover{border-bottom-color:#000}.author-info[data-v-2c7e4481]{display:flex;align-items:center;margin:60px 0 30px}.avatar-wrap[data-v-2c7e4481]{margin-left:30px;border-radius:50%;line-height:1;padding:0;overflow:hidden;box-shadow:0 10px 20px -10px #888}.avatar[data-v-2c7e4481],.avatar-wrap[data-v-2c7e4481]{width:60px;height:60px}.avatar[data-v-2c7e4481]{transition:transform 1s;animation:fade-in-down .6s;animation-delay:.2s}.avatar[data-v-2c7e4481]:hover{transform:rotate(-1turn)}.feed-subscribe[data-v-2c7e4481]{margin-left:10px}.feed-subscribe svg[data-v-2c7e4481]{position:relative;top:4px}.bg-img[data-v-2c7e4481]{width:160px;position:absolute;top:150px;right:10px;display:none}.img-suit[data-v-2c7e4481]{width:69%}@media screen and (min-width:600px){nav[data-v-2c7e4481]{display:flex;flex-direction:row;justify-content:space-between;align-items:center}nav .author-info[data-v-2c7e4481]{position:relative;top:auto;right:auto}.bg-img[data-v-2c7e4481]{width:500px;position:absolute;top:60px;right:100px;display:block}}
.social-media-list[data-v-5918860e]{list-style:none;display:flex;flex-direction:row}.social-media-list li[data-v-5918860e]{margin-right:5px}.social-media-list li[data-v-5918860e]:last-child{margin-right:0}.social-media-list li:hover .svg-icon[data-v-5918860e]{fill:#000}
footer[data-v-474a52f6]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 0}.license[data-v-474a52f6]{font-size:12px;color:#888}.license a[data-v-474a52f6]{color:#000}.copyright[data-v-474a52f6]{font-size:12px;color:#bbb}.copyright a[data-v-474a52f6]{color:#888}</style>  </head><body><div id="_saber" data-server-rendered="true"><div class="container" data-v-7c027d9a><header siteTitle="Hyggehyy" data-v-2c7e4481 data-v-7c027d9a><div class="header" data-v-2c7e4481><nav class="info" data-v-2c7e4481><div class="site-info" data-v-2c7e4481><div class="author-info" data-v-2c7e4481><a href="/" rel="author" class="title router-link-active" data-v-2c7e4481>Hyggehyy</a> <div class="avatar-wrap" data-v-2c7e4481><img src="https://ls-img-store.oss-cn-qingdao.aliyuncs.com/img/logo.jpg" class="avatar" data-v-2c7e4481></div></div> <p class="description" data-v-2c7e4481>Everything is gonna be ok.</p> <ul class="nav-links" data-v-2c7e4481><li class="nav-link" data-v-2c7e4481><a href="/" class="router-link-active" data-v-2c7e4481>Home</a></li></ul></div></nav> <div data-v-2c7e4481><ul class="social-media-list" data-v-5918860e data-v-2c7e4481><!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----> <!----></ul></div> <div class="bg-img" data-v-2c7e4481><img src="https://ls-img-store.oss-cn-qingdao.aliyuncs.com/img/bus.png?versionId=CAEQUhiBgIDK7I.vwBciIDQ5MWE5ZmU5OWM5ODRiMGJhN2Q3NTdkY2ZiZDZkYTc1" alt="123" class="img-suit" data-v-2c7e4481></div></div></header> <main aria-label="Content" class="content" data-v-7c027d9a><article itemscope="itemscope" itemtype="http://schema.org/BlogPosting" class="post typo" data-v-7c027d9a><header class="post-header" data-v-7c027d9a><h1 itemprop="name headline" class="post-title" data-v-7c027d9a>App端动态绘制分享卡片</h1> <div class="post-meta" data-v-7c027d9a><time datetime="Tue Mar 16 2021 08:00:00 GMT+0800 (GMT+08:00)" itemprop="datePublished" class="dt-published" data-v-7c027d9a>2021-03-16</time></div></header> <div itemprop="articleBody" class="post-content" data-v-7c027d9a><h2 id="遇到问题" data-v-7c027d9a>遇到问题</h2> <p data-v-7c027d9a>需求是在不同用户信息和分享内容的情况下，动态绘制下面的分享卡片，用户可以保存到手机中或通过分享API即时分享。</p> <img src="https://ls-img-store.oss-cn-qingdao.aliyuncs.com/img/post-2021-3-17.png" style="zoom:25%;" data-v-7c027d9a> <p data-v-7c027d9a>在H5端是很好实现的， 大致流程是：</p> <ol data-v-7c027d9a><li data-v-7c027d9a>使用<code data-v-7c027d9a>html2canvs</code>把html转化成canvas</li> <li data-v-7c027d9a><code data-v-7c027d9a>canvas.toDataURL(type, encoderOptions);</code> canvas转图片base64</li> <li data-v-7c027d9a><code data-v-7c027d9a>dataURLtoBlob()</code> base64转图片二进制 blob 对象</li> <li data-v-7c027d9a><code data-v-7c027d9a>URL.createObjectURL()</code> blob对象转对象URL</li> <li data-v-7c027d9a>使用<code data-v-7c027d9a>&lt;a&gt;</code>或者<code data-v-7c027d9a>uni.downloadFile()</code>下载图片即可</li></ol> <p data-v-7c027d9a>但在App端，视图层和逻辑层是分离的，在逻辑层拿不到视图层的<code data-v-7c027d9a>document</code>对象，也就无法使用<code data-v-7c027d9a>html2canvas</code>。</p> <p data-v-7c027d9a>又尝试了内置的<code data-v-7c027d9a>wxs</code>，由于<code data-v-7c027d9a>wxs</code>是运行在视图层的脚本语言，自然可以使用<code data-v-7c027d9a>document</code>对象，但是，在App端中无法使用<code data-v-7c027d9a>&lt;a&gt;</code>标签下载文件，<code data-v-7c027d9a>wxs</code>又不能使用<code data-v-7c027d9a>uni</code>各种接口，即使是通过<code data-v-7c027d9a>ownerInstance</code>传值给<code data-v-7c027d9a>uni</code>，然后调用<code data-v-7c027d9a>uni.downloadFile()</code>下载，也因为跨越两个脚本环境、且对象URL只针对当前环境有效的原因，也无法顺利进行。</p> <h2 id="可行方案" data-v-7c027d9a>可行方案</h2> <p data-v-7c027d9a>使用canvas手动绘制出卡片内容，然后使用<code data-v-7c027d9a>uni.canvasToTempFilePath()</code>获取对象URL和<code data-v-7c027d9a>uni.saveImageToPhotosAlbum()</code>保存图片到相册即可。</p> <h2 id="实现细节" data-v-7c027d9a>实现细节</h2> <p data-v-7c027d9a>代码细节</p> <div class="saber-highlight" data-lang="js" data-v-7c027d9a><pre class="saber-highlight-code language-js" data-v-7c027d9a><code class="language-js" data-v-7c027d9a>changeCanvas: function() {		
    let ctx = uni.createCanvasContext('myCanvas')
    let centerStr = 119

    // 深灰色背景
    ctx.fillStyle = '#555'
    ctx.fillRect(0, 0, 238, 456)

    // 白色背景
    // ctx.fillStyle = '#fff'
    // ctx.fillRect(10, 28, 218, 398)
    ctx.beginPath()
    ctx.moveTo(20, 28)
    // 左上角
    ctx.arc(20, 38, 10, Math.PI, Math.PI*3/2)
    // 上边线
    ctx.lineTo(218, 28)
    // 右上角
    ctx.arc(215, 38, 10, Math.PI*3/2, 0)
    // 右边线
    ctx.lineTo(225, 412)
    // 右下角
    ctx.arc(215, 412, 10, 0, Math.PI/2)
    // 下边线
    ctx.lineTo(20, 422)
    // 左下角
    ctx.arc(20, 412, 10, Math.PI/2, Math.PI)
    // 左边线
    ctx.lineTo(10, 38)
    // ctx.closePath()
    ctx.fillStyle = '#fff'
    ctx.fill()

    // 用户名
    ctx.textAlign = 'center'
    // ctx.setTextAlign('center')
    ctx.fillStyle = '#333'
    ctx.setFontSize(18)
    ctx.fillText('Hello', centerStr, 69)
    // 广告语
    ctx.fillStyle = '#999'
    ctx.setFontSize(10)
    ctx.fillText('在'+this.$mConfig.appName+'App发现了一篇好文章', centerStr, 90)

    // 文章标题
    ctx.fillStyle = '#333'
    ctx.setFontSize(18)
    let str = this.passageDetail.title
    ctx.fillText(str.substring(0, 10), centerStr, 260)
    if(str.length &gt; 10) ctx.fillText(str.substring(10, 18)+'...', centerStr, 282)

    // 文章摘要
    ctx.fillStyle = '#888'
    ctx.setFontSize(12)
    let profile = this.passageDetail.describe
    ctx.fillText(profile.substring(0, 13), centerStr, 310)
    if(profile.length &gt; 10) ctx.fillText(profile.substring(13, 22)+'...', centerStr, 329)

    // 间隔线
    ctx.strokeStyle = '#CED0D1'
    ctx.moveTo(30, 350)
    ctx.lineTo(208, 350)
    ctx.stroke()

    // 提示
    ctx.textAlign = 'left'
    ctx.fillText('长按识别二维码收听', 90, 380)
    ctx.fillText(this.userinfo.user_nickname, 90, 399)

    // 文章logo
    // ctx.drawImage(this.shareImgMetarials[1].path, 80, 126, 119, 119)
    ctx.drawImage(this.passageDetail.thumbnail, 66, 109, 119, 119)

    // 二维码
    ctx.drawImage(this.shareQrcode, 30, 360, 46, 46)

    // 用户logo
    ctx.save()
    ctx.stroke()
    ctx.beginPath();
    ctx.moveTo(62, 12)
    ctx.arc(117, 27, 15, 0, Math.PI*2, false);
    ctx.clip();
    ctx.drawImage(this.userinfo.avatar, 102, 12, 30, 30)
    ctx.restore()

    ctx.draw()
}</code></pre></div><h2 id="总结" data-v-7c027d9a>总结</h2> <p data-v-7c027d9a>App的混合开发确实方便快捷，但是也会在不时遇到的因为非原生开发带来的棘手问题时，感觉力不从心， 而转向原生开发又违背混合开发的初心，现在只能先暂时寄希望于行业能力慢慢迭代，打破这个循环。</p></div> <a href="/2021/03/16/App端动态绘制分享卡片" aria-current="page" hidden="hidden" class="u-url router-link-exact-active router-link-active"></a> <div class="post-meta" data-v-7c027d9a><div class="category" data-v-7c027d9a><span class="label" data-v-7c027d9a>Category:</span> </div> <div class="tag" data-v-7c027d9a><span class="label" data-v-7c027d9a>Tags:</span> </div></div> <div class="pagination" data-v-7c027d9a><a href="/2021/03/07/跳转第三方App" class="prev"><strong>prev post</strong> <p>跳转第三方App</p></a> <!----></div></article> <!----></main> <footer siteTitle="Hyggehyy" class="footer" data-v-474a52f6 data-v-7c027d9a><!----></footer></div></div><script src="/_saber/js/client.48e910b2.js" defer></script><script src="/_saber/js/page--_posts-2021-03-16-App----------md.f45b5f74.js" defer></script></body></html>
